name: docker-remote

on:
  workflow_dispatch:
  pull_request:
  push:
    branches: ["**"]

permissions:
  contents: read

concurrency:
  group: docker-remote-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docker-tester:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (read-only)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Build tester image
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          docker build --target tester --tag openclaw-omnibridge:tester .

      - name: Run tests in locked-down container
        run: |
          docker run --rm \
            --network none \
            --cap-drop ALL \
            --security-opt no-new-privileges \
            --pids-limit 256 \
            --memory 2g \
            --cpus 1.5 \
            --shm-size 2g \
            openclaw-omnibridge:tester

  docker-ingress-artifacts:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout (read-only)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Build runtime image
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          docker build --target runner --tag openclaw-omnibridge:runner .

      - name: Verify Fastify/Nest ingress artifacts exist
        run: |
          docker run --rm --network none --entrypoint sh openclaw-omnibridge:runner -lc \
            'test -f /app/dist/src/ingress/fastify/main.js && test -f /app/dist/src/ingress/nest/main.js'

  docker-redis-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout (read-only)
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Build tester image
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          docker build --target tester --tag openclaw-omnibridge:tester .

      - name: Run Redis-backed integration tests
        run: |
          trap 'docker rm -f openclaw-redis >/dev/null 2>&1 || true; docker network rm openclaw-redis-net >/dev/null 2>&1 || true' EXIT
          docker network create openclaw-redis-net
          docker run -d --rm --name openclaw-redis --network openclaw-redis-net redis:7-alpine
          docker run --rm \
            --network openclaw-redis-net \
            --cap-drop ALL \
            --security-opt no-new-privileges \
            --pids-limit 256 \
            --memory 2g \
            --cpus 1.5 \
            -e REDIS_URL=redis://openclaw-redis:6379 \
            openclaw-omnibridge:tester \
            npm run test:integration
