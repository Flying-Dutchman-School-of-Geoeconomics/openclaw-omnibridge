# Refinement Map: TLA+ Model to Code

## Receive(m)

Model transition:

- Adds message to `pending` if nonce unused.

Code mapping:

- `BridgeEngine.processInbound()` pre-verification checks.
- Replay key generated by `makeReplayKey()`.
- Replay decision via `ReplayStore`.

## Verify(m)

Model transition:

- Marks pending message as verified.

Code mapping:

- `adapter.verify(raw)` and `adapter.normalize(raw, verification)`.

## Ingest(m)

Model transition:

- Moves verified message to processed set.

Code mapping:

- `gateway.ingest(canonical)` followed by `idempotencyStore.markProcessed(raw.id)`.

## Forward(m, c)

Model transition:

- Forwards processed message to policy-permitted channel.

Code mapping:

- `BridgeEngine.forward()` with `rule.fanoutTargets` and enabled-target checks.

## Invariants

- Auth-before-ingest: `PolicyEngine.enforceAuthentication`.
- No replay accept: `ReplayStore.seen/store` + nonce hash key.
- Forward bounded: `PolicyEngine.resolveRule` + explicit fanout target list.
